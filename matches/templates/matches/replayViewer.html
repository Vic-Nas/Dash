<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Replay: {{ metadata.player }} - Dash Arena</title>
  <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: system-ui, sans-serif;
      background: #0d0f1a;
      color: #e6e6e6;
      overflow: hidden;
    }
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      padding: 20px;
    }
    #replayCanvas {
      border: 2px solid #2a2f6b;
      background: #121428;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    .info-panel {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(18,20,40,0.95);
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #2a2f6b;
      min-width: 220px;
    }
    .info-item {
      margin-bottom: 8px;
      font-size: 14px;
    }
    .info-label {
      color: #9ca3af;
      margin-right: 8px;
    }
    .info-value {
      color: #fff;
      font-weight: 600;
    }
    .controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(18,20,40,0.95);
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #2a2f6b;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      max-width: 90%;
    }
    .control-btn {
      padding: 10px 20px;
      background: #2a2f6b;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }
    .control-btn:hover:not(:disabled) {
      background: #3940a3;
    }
    .control-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .control-btn.primary {
      background: #5b7bff;
    }
    .control-btn.primary:hover:not(:disabled) {
      background: #4a6aef;
    }
    .speed-control {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .speed-btn {
      padding: 6px 12px;
      background: #2a2f6b;
      color: #9ca3af;
      border: 1px solid #3940a3;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    .speed-btn.active {
      background: #5b7bff;
      color: #fff;
      border-color: #5b7bff;
    }
    .timeline {
      flex: 1;
      max-width: 400px;
      margin: 0 16px;
      min-width: 200px;
    }
    .timeline input[type="range"] {
      width: 100%;
      cursor: pointer;
    }
    .timeline-time {
      text-align: center;
      font-size: 13px;
      color: #9ca3af;
      margin-top: 4px;
    }
    .back-link {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 10px 20px;
      background: #1a1d2e;
      color: #9ca3af;
      border: 2px solid #2a2f6b;
      border-radius: 8px;
      text-decoration: none;
      font-size: 14px;
    }
    .back-link:hover {
      background: #2a2f6b;
      color: #fff;
    }
    .replay-status {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(18,20,40,0.98);
      padding: 40px;
      border-radius: 12px;
      border: 2px solid #2a2f6b;
      text-align: center;
      z-index: 100;
    }
    .replay-status h2 {
      color: #5b7bff;
      font-size: 28px;
      margin-bottom: 16px;
    }
    .payment-status {
      text-align: center;
      margin-top: 12px;
      font-size: 14px;
      min-height: 20px;
    }
    .balance-display {
      position: absolute;
      top: 20px;
      right: 180px;
      padding: 10px 16px;
      background: rgba(42, 47, 107, 0.8);
      border-radius: 8px;
      font-size: 15px;
      border: 1px solid #2a2f6b;
    }
    .balance-amount {
      color: #fbbf24;
      font-weight: 700;
    }
    @media (max-width: 768px) {
      .info-panel {
        position: static;
        margin-bottom: 12px;
        min-width: auto;
        width: 100%;
      }
      .controls {
        position: static;
        margin-top: 12px;
        transform: none;
        justify-content: center;
      }
      .timeline {
        flex-basis: 100%;
        max-width: none;
      }
      .balance-display {
        position: static;
        margin-bottom: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="balance-display">
      üí∞ <span class="balance-amount" id="coinBalance">{{ profile.coins }}</span> coins
    </div>
    
    <a href="/matches/replays/" class="back-link">‚Üê Back to Replays</a>

    <div class="info-panel">
      <div class="info-item">
        <span class="info-label">Type:</span>
        <span class="info-value">{{ metadata.type }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Player:</span>
        <span class="info-value">{{ metadata.player }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Score:</span>
        <span class="info-value">{{ metadata.score }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Time:</span>
        <span class="info-value">{{ metadata.time }}</span>
      </div>
      {% if metadata.match_type %}
      <div class="info-item">
        <span class="info-label">Match:</span>
        <span class="info-value">{{ metadata.match_type }}</span>
      </div>
      {% endif %}
      <div class="info-item">
        <span class="info-label">Date:</span>
        <span class="info-value">{{ metadata.date|date:"M d, Y" }}</span>
      </div>
    </div>
    <canvas id="replayCanvas" width="600" height="600"></canvas>

    <div class="controls">
      {% if hasAccess %}
        <button class="control-btn primary" id="playPauseBtn" onclick="togglePlayPause()">‚ñ∂ Play</button>
      {% else %}
        <button class="control-btn primary" id="playPauseBtn" onclick="handlePayment()">
          ‚ñ∂ Pay {{ replayCost }} coins to watch
        </button>
      {% endif %}
      <button class="control-btn" onclick="restartReplay()">üîÑ Restart</button>
      <div class="timeline">
        <input 
          type="range" 
          id="timelineSlider" 
          min="0" 
          max="100" 
          value="0" 
          {% if not has_access %}disabled{% endif %}
          oninput="seekReplay(this.value)"
        >
        <div class="timeline-time">
          <span id="currentTime">0:00</span> / <span id="totalTime">0:00</span>
        </div>
      </div>
      <div class="speed-control">
        <span style="color:#9ca3af;font-size:13px;">Speed:</span>
        <button class="speed-btn" onclick="setSpeed(0.5, this)">0.5x</button>
        <button class="speed-btn active" onclick="setSpeed(1, this)">1x</button>
        <button class="speed-btn" onclick="setSpeed(2, this)">2x</button>
        <button class="speed-btn" onclick="setSpeed(4, this)">4x</button>
      </div>
    </div>
    <div id="paymentStatus" class="payment-status"></div>

    <div class="replay-status" id="replayStatus" style="display:none;">
      <h2>Replay Ended</h2>
      <p style="color:#9ca3af;margin-bottom:20px;">Click Restart to watch again</p>
    </div>
  </div>

  <script>
    var hasAccess = {{ hasAccess|lower }};
    var replayType = '{{ replayType }}';
    var replayId = {{ replayId }};
    var replayData = {{ replayData|safe }};
    var currentBalance = parseFloat('{{ profile.coins }}');
    var replayCost = {{ replayCost }};
    
    function getCookie(name) {
      var value = '; ' + document.cookie;
      var parts = value.split('; ' + name + '=');
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function handlePayment() {
      var playBtn = document.getElementById('playPauseBtn');
      var paymentStatus = document.getElementById('paymentStatus');
      var balanceDisplay = document.getElementById('coinBalance');
      
      if (currentBalance < replayCost) {
        paymentStatus.style.color = '#ef4444';
        paymentStatus.textContent = 'Insufficient coins! Need ' + replayCost + ', you have ' + currentBalance;
        return;
      }
      
      playBtn.disabled = true;
      paymentStatus.style.color = '#9ca3af';
      paymentStatus.textContent = 'Processing payment...';
      
      fetch('/matches/replays/watch/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          type: replayType,
          id: replayId
        })
      })
      .then(function(response) {
        return response.json();
      })
      .then(function(data) {
        if (data.success) {
          if (data.paid) {
            currentBalance = data.newBalance;
            balanceDisplay.textContent = currentBalance.toFixed(2);
            paymentStatus.style.color = '#10b981';
            paymentStatus.textContent = 'Payment successful! ' + data.cost + ' coins deducted. Reloading...';
            setTimeout(function() {
              location.reload();
            }, 1500);
          } else {
            paymentStatus.style.color = '#10b981';
            paymentStatus.textContent = data.message + '. Reloading...';
            setTimeout(function() {
              location.reload();
            }, 1500);
          }
        } else {
          playBtn.disabled = false;
          paymentStatus.style.color = '#ef4444';
          paymentStatus.textContent = data.error || 'Payment failed';
        }
      })
      .catch(function(err) {
        playBtn.disabled = false;
        paymentStatus.style.color = '#ef4444';
        paymentStatus.textContent = 'Network error: ' + err.message;
      });
    }

    var canvas = document.getElementById('replayCanvas');
    var ctx = canvas.getContext('2d');
    
    var currentFrame = 0;
    var isPlaying = false;
    var playbackSpeed = 1;
    var animationFrameId = null;
    var lastFrameTime = 0;
    
    function adjustCanvasSize() {
      var maxWidth = window.innerWidth - 40;
      var maxHeight = window.innerHeight - 300;
      var size = Math.min(600, maxWidth, maxHeight);
      canvas.width = size;
      canvas.height = size;
    }
    
    adjustCanvasSize();
    
    if (!replayData || !replayData.frames || replayData.frames.length === 0) {
      document.getElementById('replayStatus').style.display = 'block';
      document.getElementById('replayStatus').innerHTML = '<h2>No Replay Data</h2><p style="color:#9ca3af;">This replay does not contain playback data.</p>';
    } else {
      renderFrame(0);
      updateTimeline();
    }
    
    function togglePlayPause() {
      if (!hasAccess) {
        handlePayment();
        return;
      }
      
      isPlaying = !isPlaying;
      var btn = document.getElementById('playPauseBtn');
      
      if (isPlaying) {
        btn.textContent = '‚è∏ Pause';
        playReplay();
      } else {
        btn.textContent = '‚ñ∂ Play';
        if (animationFrameId) {
          cancelAnimationFrame(animationFrameId);
        }
      }
    }
    
    function playReplay() {
      if (!replayData || !replayData.frames) return;
      
      var frameDelay = (replayData.frameDuration || 150) / playbackSpeed;
      
      function animate(timestamp) {
        if (!isPlaying) return;
        
        if (!lastFrameTime) lastFrameTime = timestamp;
        var elapsed = timestamp - lastFrameTime;
        
        if (elapsed >= frameDelay) {
          currentFrame++;
          
          if (currentFrame >= replayData.frames.length) {
            isPlaying = false;
            document.getElementById('playPauseBtn').textContent = '‚ñ∂ Play';
            document.getElementById('replayStatus').style.display = 'block';
            return;
          }
          
          renderFrame(currentFrame);
          updateTimeline();
          lastFrameTime = timestamp;
        }
        
        animationFrameId = requestAnimationFrame(animate);
      }
      
      animationFrameId = requestAnimationFrame(animate);
    }
    
    function restartReplay() {
      currentFrame = 0;
      isPlaying = false;
      document.getElementById('playPauseBtn').textContent = hasAccess ? '‚ñ∂ Play' : '‚ñ∂ Pay ' + replayCost + ' coins to watch';
      document.getElementById('replayStatus').style.display = 'none';
      renderFrame(0);
      updateTimeline();
    }
    
    function seekReplay(value) {
      if (!replayData || !replayData.frames || !hasAccess) return;
      
      var frameIndex = Math.floor((value / 100) * (replayData.frames.length - 1));
      currentFrame = frameIndex;
      renderFrame(currentFrame);
      updateTimeline();
    }
    
    function setSpeed(speed, btn) {
      playbackSpeed = speed;
      var buttons = document.querySelectorAll('.speed-btn');
      buttons.forEach(function(button) {
        button.classList.remove('active');
      });
      btn.classList.add('active');
    }
    
    function updateTimeline() {
      if (!replayData || !replayData.frames) return;
      
      var progress = (currentFrame / (replayData.frames.length - 1)) * 100;
      document.getElementById('timelineSlider').value = progress;
      
      var currentSeconds = Math.floor(currentFrame * (replayData.frameDuration || 150) / 1000);
      var totalSeconds = Math.floor((replayData.frames.length - 1) * (replayData.frameDuration || 150) / 1000);
      
      document.getElementById('currentTime').textContent = formatTime(currentSeconds);
      document.getElementById('totalTime').textContent = formatTime(totalSeconds);
    }
    
    function formatTime(seconds) {
      var mins = Math.floor(seconds / 60);
      var secs = seconds % 60;
      return mins + ':' + (secs < 10 ? '0' : '') + secs;
    }
    
    function renderFrame(frameIndex) {
      if (!replayData || !replayData.frames || !replayData.frames[frameIndex]) return;
      
      var frame = replayData.frames[frameIndex];
      var gridSize = frame.gridSize || 20;
      var cellSize = canvas.width / gridSize;
      
      ctx.fillStyle = '#121428';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      ctx.strokeStyle = '#23264a';
      ctx.lineWidth = 1;
      for (var i = 0; i <= gridSize; i++) {
        ctx.beginPath();
        ctx.moveTo(i * cellSize, 0);
        ctx.lineTo(i * cellSize, canvas.height);
        ctx.stroke();
        
        ctx.beginPath();
        ctx.moveTo(0, i * cellSize);
        ctx.lineTo(canvas.width, i * cellSize);
        ctx.stroke();
      }
      
      ctx.fillStyle = '#ef4444';
      if (frame.walls) {
        frame.walls.forEach(function(wall) {
          ctx.fillRect(
            wall.x * cellSize + 2,
            wall.y * cellSize + 2,
            cellSize - 4,
            cellSize - 4
          );
        });
      }
      
      if (frame.countdownWalls) {
        frame.countdownWalls.forEach(function(wall) {
          var alpha = 0.3 + (0.7 * (3 - wall.secondsLeft) / 3);
          ctx.fillStyle = 'rgba(239, 68, 68, ' + alpha + ')';
          ctx.fillRect(
            wall.x * cellSize + 2,
            wall.y * cellSize + 2,
            cellSize - 4,
            cellSize - 4
          );
          
          ctx.fillStyle = '#fff';
          ctx.font = 'bold ' + Math.max(12, cellSize * 0.5) + 'px system-ui';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(
            wall.secondsLeft,
            (wall.x + 0.5) * cellSize,
            (wall.y + 0.5) * cellSize
          );
        });
      }
      
      if (frame.player) {
        drawPlayer(frame.player, cellSize, '#5b7bff');
      }
      
      if (frame.bots) {
        frame.bots.forEach(function(bot) {
          if (bot.alive) {
            drawPlayer(bot, cellSize, '#ef4444');
          }
        });
      }
      
      if (frame.players) {
        Object.values(frame.players).forEach(function(player) {
          if (player.alive) {
            drawPlayer(player, cellSize, player.playerColor || '#5b7bff');
          }
        });
      }
    }
    
    function drawPlayer(player, cellSize, color) {
      var px = player.x * cellSize + cellSize / 2;
      var py = player.y * cellSize + cellSize / 2;
      
      ctx.save();
      ctx.translate(px, py);
      
      var angle = 0;
      if (player.direction === 'DOWN') angle = Math.PI;
      else if (player.direction === 'LEFT') angle = -Math.PI / 2;
      else if (player.direction === 'RIGHT') angle = Math.PI / 2;
      
      ctx.rotate(angle);
      
      ctx.fillStyle = color;
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 2;
      ctx.lineJoin = 'miter';
      
      var size = cellSize * 0.7;
      
      ctx.beginPath();
      ctx.moveTo(0, -size / 2);
      ctx.lineTo(size / 3, size / 6);
      ctx.lineTo(size / 6, size / 6);
      ctx.lineTo(size / 6, size / 2);
      ctx.lineTo(-size / 6, size / 2);
      ctx.lineTo(-size / 6, size / 6);
      ctx.lineTo(-size / 3, size / 6);
      ctx.closePath();
      ctx.fill();
      ctx.stroke();
      
      ctx.restore();
    }
    
    window.addEventListener('resize', function() {
      adjustCanvasSize();
      renderFrame(currentFrame);
    });
  </script>
</body>
</html>