<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Private Lobbies - Dash Arena</title>
  <style>
    *{box-sizing:border-box;}
    body{font-family:system-ui,sans-serif;margin:0;background:#0d0f1a;color:#e6e6e6;}
    header{background:#121428;border-bottom:1px solid #23264a;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;}
    .brand{font-weight:700;font-size:20px;}
    a{color:#5b7bff;text-decoration:none;}
    a:hover{text-decoration:underline;}
    .container{max-width:1200px;margin:24px auto;padding:0 20px;}
    h1{margin:0 0 24px;font-size:28px;}
    .section{background:#121428;border:1px solid #23264a;border-radius:12px;padding:24px;margin-bottom:24px;}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;margin-top:16px;}
    .card{background:#1a1d35;border:1px solid #2a2f6b;border-radius:10px;padding:16px;transition:all .2s;}
    .card:hover{border-color:#3940a3;transform:translateY(-2px);}
    .card-title{font-weight:600;font-size:16px;margin-bottom:8px;}
    .card-meta{font-size:13px;color:#9ca3af;margin:8px 0;}
    .badge{display:inline-block;background:#2a2f6b;padding:4px 12px;border-radius:20px;font-size:12px;margin:4px 0;}
    .badge.waiting{background:#f59e0b;}
    .badge.progress{background:#3b82f6;}
    .btn{background:#2a2f6b;color:#fff;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-size:14px;display:inline-block;margin:8px 0;}
    .btn:hover{background:#3940a3;}
    .btn.primary{background:#5b7bff;}
    .btn.primary:hover{background:#3940a3;}
    .btn.danger{background:#ef4444;}
    .btn.danger:hover{background:#dc2626;}
    .input-group{display:flex;gap:8px;margin:16px 0;}
    .input-group input{flex:1;padding:12px;background:#1a1d35;border:1px solid #2a2f6b;border-radius:8px;color:#fff;}
    .input-group button{padding:12px 24px;}
    .alert{padding:16px;border-radius:8px;margin-bottom:24px;}
    .alert-info{background:#1e40af;border:1px solid #3b82f6;}
    .alert-success{background:#065f46;border:1px solid #10b981;}
    .alert-error{background:#991b1b;border:1px solid #ef4444;}
    .code-display{background:#1a1d35;padding:16px;border-radius:8px;border:2px solid #3b82f6;font-family:monospace;font-size:20px;font-weight:700;letter-spacing:2px;text-align:center;margin:16px 0;}
    .stats{display:flex;gap:16px;margin:12px 0;font-size:14px;}
    .stat{background:#1a1d35;padding:8px 12px;border-radius:6px;}
    .stat-label{color:#9ca3af;}
    .stat-value{color:#5b7bff;font-weight:600;}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center;}
    .modal.active{display:flex;}
    .modal-content{background:#121428;border:1px solid #23264a;border-radius:12px;padding:24px;max-width:500px;width:90%;}
    .close-modal{float:right;font-size:28px;font-weight:700;cursor:pointer;color:#9ca3af;}
    .close-modal:hover{color:#e6e6e6;}
  </style>
</head>
<body>
  <header>
    <div class="brand">üîí Private Lobbies</div>
    <a href="/dashboard/" style="color:#5b7bff;">‚Üê Back to Dashboard</a>
  </header>

  <div class="container">
    <h1>Private Match Lobbies</h1>
    <p>Create private lobbies with friends using shareable codes. Cost: {{ creationCost }} coins</p>

    <!-- Join Lobby Section (FIRST) -->
    <div class="section">
      <h2>Join Existing Lobby</h2>
      <p>Enter a lobby code to join a friend's private lobby:</p>
      <div class="input-group">
        <input type="text" id="joinCode" placeholder="Enter 6-character code (e.g., ABC123)" maxlength="6" style="text-transform:uppercase;">
        <button class="btn primary" onclick="joinLobby()">Join Lobby</button>
      </div>
    </div>

    <!-- Create Lobby Section (SECOND) -->
    <div class="section">
      <h2>Create New Lobby</h2>
      <p>Select a match type and create a private lobby with a shareable code:</p>
      
      {% if matchTypes %}
      <div class="grid" style="grid-template-columns:repeat(auto-fill,minmax(250px,1fr));">
        {% for matchType in matchTypes %}
        <div class="card" style="cursor:pointer;" onclick="selectMatchType({{ matchType.id }}, '{{ matchType.name }}')">
          <div class="card-title">{{ matchType.name }}</div>
          <div class="card-meta">{{ matchType.description }}</div>
          <div class="stats" style="margin-top:12px;">
            <div class="stat">
              <div class="stat-label">Entry Fee</div>
              <div class="stat-value">{{ matchType.entryFee|floatformat:0 }}</div>
            </div>
            <div class="stat">
              <div class="stat-label">Players</div>
              <div class="stat-value">{{ matchType.playersRequired }}-{{ matchType.maxPlayers }}</div>
            </div>
          </div>
          <button class="btn primary" style="width:100%;margin-top:12px;" onclick="event.stopPropagation();createLobby({{ matchType.id }})">Create ({{ creationCost }} coins)</button>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="alert alert-info">No match types available.</div>
      {% endif %}
    </div>

    <!-- Created Lobbies -->
    {% if createdLobbies %}
    <div class="section">
      <h2>Your Created Lobbies</h2>
      <div class="grid">
        {% for lobby in createdLobbies %}
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:start;">
            <div>
              <div class="card-title">{{ lobby.matchType.name }}</div>
              <div class="card-meta">Created {{ lobby.createdAt|timesince }} ago</div>
            </div>
            <span class="badge {% if lobby.status == 'WAITING' %}waiting{% elif lobby.status == 'IN_PROGRESS' %}progress{% endif %}">{{ lobby.status }}</span>
          </div>
          
          {% if lobby.status == 'WAITING' %}
          <div class="code-display">{{ lobby.code }}</div>
          <p style="font-size:13px;color:#9ca3af;margin:8px 0;">Share this code with friends to invite them</p>
          
          <div class="stats">
            <div class="stat">
              <div class="stat-label">Members</div>
              <div class="stat-value">{{ lobby.members.count }}/{{ lobby.matchType.maxPlayers }}</div>
            </div>
            <div class="stat">
              <div class="stat-label">Expires In</div>
              <div class="stat-value">{{ lobby.expiresAt|timeuntil }}</div>
            </div>
          </div>
          {% else %}
          <p style="font-size:13px;color:#9ca3af;margin:8px 0;">Status: {{ lobby.status }}</p>
          {% if lobby.match %}
          <a href="{% url 'matches:lobby' lobby.match.id %}" class="btn primary" style="width:100%;margin-top:12px;">View Match</a>
          {% endif %}
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Joined Lobbies -->
    {% if joinedLobbies %}
    <div class="section">
      <h2>Lobbies You've Joined</h2>
      <div class="grid">
        {% for membership in joinedLobbies %}
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:start;">
            <div>
              <div class="card-title">{{ membership.lobby.matchType.name }}</div>
              <div class="card-meta">Created by {{ membership.lobby.creator.username }}</div>
            </div>
            <span class="badge {% if membership.lobby.status == 'WAITING' %}waiting{% elif membership.lobby.status == 'IN_PROGRESS' %}progress{% endif %}">{{ membership.lobby.status }}</span>
          </div>
          
          <div class="code-display">{{ membership.lobby.code }}</div>
          
          <div class="stats">
            <div class="stat">
              <div class="stat-label">Members</div>
              <div class="stat-value">{{ membership.lobby.members.count }}/{{ membership.lobby.matchType.maxPlayers }}</div>
            </div>
            {% if membership.lobby.status == 'WAITING' %}
            <div class="stat">
              <div class="stat-label">Expires In</div>
              <div class="stat-value">{{ membership.lobby.expiresAt|timeuntil }}</div>
            </div>
            {% endif %}
          </div>
          
          {% if membership.lobby.match and membership.lobby.status == 'IN_PROGRESS' %}
          <a href="{% url 'matches:lobby' membership.lobby.match.id %}" class="btn primary" style="width:100%;margin-top:12px;">Join Match</a>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Modal for alerts -->
  <div class="modal" id="alertModal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal()">&times;</span>
      <h2 id="alertTitle">Alert</h2>
      <p id="alertMessage"></p>
      <button class="btn primary" style="width:100%;margin-top:16px;" onclick="closeModal()">OK</button>
    </div>
  </div>

  <script>
    // Get CSRF token from cookie
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function showAlert(title, message, isSuccess = false) {
      document.getElementById('alertTitle').textContent = title;
      document.getElementById('alertMessage').textContent = message;
      document.getElementById('alertModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('alertModal').classList.remove('active');
    }

    function createLobby(matchTypeId) {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Creating...';

      fetch('/matches/private/create/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({matchTypeId: matchTypeId})
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          showAlert('‚úÖ Lobby Created!', `Your lobby code is: ${data.lobbyCode}\n\nShare this code with friends to invite them!`, true);
          setTimeout(() => location.reload(), 2000);
        } else {
          showAlert('‚ùå Error', data.error);
        }
      })
      .catch(e => {
        showAlert('‚ùå Error', e.message);
      })
      .finally(() => {
        btn.disabled = false;
        btn.textContent = 'Create (' + {{ creationCost }} + ' coins)';
      });
    }

    function joinLobby() {
      const code = document.getElementById('joinCode').value.toUpperCase().trim();
      if (!code || code.length !== 6) {
        showAlert('‚ùå Invalid Code', 'Code must be 6 characters');
        return;
      }

      fetch('/matches/private/join/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({code: code})
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          showAlert('‚úÖ Joined!', data.message, true);
          setTimeout(() => location.reload(), 1000);
        } else {
          showAlert('‚ùå Error', data.error);
        }
      })
      .catch(e => {
        showAlert('‚ùå Error', e.message);
      });
    }

    // Allow Enter key in code input
    document.getElementById('joinCode').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') joinLobby();
    });
  </script>
</body>
</html>
