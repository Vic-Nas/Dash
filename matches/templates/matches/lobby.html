<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
  <title>Match Lobby - Dash Arena</title>
  <style>
    *{box-sizing:border-box;}
    body{font-family:system-ui,sans-serif;margin:0;background:#0d0f1a;color:#e6e6e6;}
    header{background:#121428;border-bottom:1px solid #23264a;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;}
    .brand{font-weight:700;font-size:20px;}
    .user{display:flex;align-items:center;gap:16px;}
    .coins{background:#2a2f6b;padding:8px 16px;border-radius:20px;font-weight:600;}
    .btn{background:#2a2f6b;color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:14px;text-decoration:none;display:inline-block;}
    .btn:hover{background:#3940a3;}
    .btn-danger{background:#991b1b;}
    .btn-danger:hover{background:#7f1d1d;}
    .btn-success{background:#059669;}
    .btn-success:hover{background:#047857;}
    .container{max-width:800px;margin:40px auto;padding:0 20px;}
    .lobby-card{background:#121428;border:1px solid #23264a;border-radius:12px;padding:32px;text-align:center;}
    h1{margin:0 0 8px;font-size:28px;}
    .match-type{color:#9ca3af;margin-bottom:24px;}
    .status{background:#2a2f6b;display:inline-block;padding:8px 16px;border-radius:20px;margin-bottom:24px;font-weight:600;}
    .status.starting{background:#10b981;}
    .status.in-progress{background:#f59e0b;}
    .players{margin:32px 0;}
    .player-count{font-size:48px;font-weight:700;color:#5b7bff;margin-bottom:16px;}
    .player-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;margin-top:24px;}
    .player-item{background:#1a1d35;padding:12px;border-radius:8px;border:1px solid #2a2f6b;}
    .match-info{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin:24px 0;text-align:center;}
    .info-box{background:#1a1d35;padding:16px;border-radius:8px;}
    .info-label{font-size:12px;color:#9ca3af;margin-bottom:4px;}
    .info-value{font-size:18px;font-weight:600;}
    .actions{margin-top:24px;display:flex;gap:12px;justify-content:center;flex-wrap:wrap;}
    .waiting-msg{color:#9ca3af;margin-top:16px;}
    .force-start-warning{background:#1a1d35;border:1px solid #f59e0b;border-radius:8px;padding:16px;margin:16px 0;color:#f59e0b;}
    .force-not-ready{background:#1a1d35;border:1px solid #ef4444;border-radius:8px;padding:16px;margin:16px 0;color:#ef4444;}
    .auto-start-timer{background:#1a1d35;border:2px solid #10b981;border-radius:8px;padding:20px;margin:16px 0;animation:pulse 2s ease-in-out infinite;}
    .timer-display{font-size:36px;font-weight:700;color:#10b981;margin:8px 0;}
    @keyframes pulse {
      0%, 100% { border-color:#10b981; }
      50% { border-color:#34d399; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">Dash Arena</div>
    <div class="user">
      <span class="coins">üí∞ {{ profile.coins|floatformat:0 }}</span>
      <span>{{ user.username }}</span>
    </div>
  </header>

  <div class="container">
    <div class="lobby-card">
      <h1>Match Lobby</h1>
      <div class="match-type">{{ match.matchType.name }}</div>
      
      <div class="status {% if match.status == 'STARTING' %}starting{% elif match.status == 'IN_PROGRESS' %}in-progress{% endif %}">
        {{ match.status }}
      </div>

      <div class="players">
        <div class="player-count">
          {{ match.currentPlayers }} / {{ match.matchType.maxPlayers }}
        </div>
        <div>Players in lobby (min: {{ match.playersRequired }})</div>
      </div>

      <div class="match-info">
        <div class="info-box">
          <div class="info-label">Total Pot</div>
          <div class="info-value">{{ match.totalPot|floatformat:0 }} coins</div>
        </div>
        <div class="info-box">
          <div class="info-label">Grid Size</div>
          <div class="info-value">{{ match.gridSize }}√ó{{ match.gridSize }}</div>
        </div>
        <div class="info-box">
          <div class="info-label">Speed</div>
          <div class="info-value">{{ match.speed }}</div>
        </div>
      </div>

      {% if privateCode %}
      <div style="background:#1a1d35;border:2px solid #10b981;border-radius:8px;padding:16px;margin:16px 0;text-align:center;">
        <div style="font-size:12px;color:#9ca3af;margin-bottom:8px;">üîí Share Code</div>
        <div style="font-size:28px;font-weight:700;color:#10b981;letter-spacing:2px;font-family:monospace;">{{ privateCode }}</div>
        <div style="font-size:12px;color:#9ca3af;margin-top:8px;">Friends can join with this code</div>
      </div>
      {% endif %}

      <div style="background:#1a1d35;border:1px solid #2a2f6b;border-radius:8px;padding:16px;margin:16px 0;">
        <h3 style="font-size:14px;color:#5b7bff;margin-bottom:8px;">‚ö° Quick Rules</h3>
        <ul style="font-size:13px;color:#9ca3af;line-height:1.7;padding-left:20px;">
          <li>+1 point per wall spawned</li>
          <li>Eliminated at 50 hits (hits don't reduce score)</li>
          <li>Last standing wins the pot!</li>
        </ul>
      </div>

      <div class="player-list">
        {% for p in participants %}
        <div class="player-item">
          {{ p.player.username }}
          {% if p.player == user %}(You){% endif %}
        </div>
        {% endfor %}
        
        {% for i in "x"|rjust:match.matchType.maxPlayers|slice:match.currentPlayers %}
        <div class="player-item" style="opacity:0.3;">
          Empty slot
        </div>
        {% endfor %}
      </div>

      {% if match.status == 'WAITING' %}
        {% if match.currentPlayers < match.playersRequired %}
          <div class="force-not-ready">
            <strong>‚è≥ Waiting for Players</strong>
            <p style="margin:8px 0;">Need at least {{ match.playersRequired }} players to start. Currently have {{ match.currentPlayers }}.</p>
            <p style="margin:8px 0;font-size:14px;">Wait for <span id="missingPlayers"></span> more player<span id="playerPlural"></span> to join.</p>
          </div>
        {% else %}
          <div class="auto-start-timer" id="autoStartTimer">
            <strong style="color:#10b981;font-size:18px;">‚úì Ready to Start!</strong>
            <div class="timer-display" id="timerDisplay">30</div>
            <p style="margin:8px 0;color:#e6e6e6;">Match starts automatically in <span id="timerSeconds">30</span> seconds</p>
            <p style="margin:0;font-size:14px;color:#9ca3af;">or force start now by paying for empty slots</p>
          </div>
          
          <div class="force-start-warning">
            <strong>üí∞ Force Start Option</strong>
            <p style="margin:8px 0;">Don't want to wait? Pay for the <strong id="emptySlots"></strong> empty slots to start immediately!</p>
            <p style="margin:8px 0;font-size:14px;">Cost: <strong id="forceCost"></strong> coins ({{ match.matchType.entryFee|floatformat:0 }} per slot)</p>
          </div>
        {% endif %}

      {% elif match.status == 'STARTING' %}
        <div class="waiting-msg" style="color:#10b981;">
          Match starting soon!
        </div>
      {% endif %}

      <div class="actions">
        {% if match.status == 'WAITING' and match.currentPlayers >= match.playersRequired %}
          <button class="btn btn-success" onclick="forceStartMatch()" id="forceStartBtn">
            Force Start (Pay for Empty Slots)
          </button>
        {% endif %}
        <button class="btn btn-danger" onclick="leaveLobby()">Leave Lobby</button>
      </div>
    </div>
  </div>

  <script>
    let autoRefreshInterval = null;
    let countdownInterval = null;
    let timeLeft = 30;

    // FIXED: Store countdown start time in localStorage to persist across refreshes
    const COUNTDOWN_KEY = 'match_{{ match.id }}_countdown_start';
    const READY_KEY = 'match_{{ match.id }}_is_ready';

    function getCookie(name) {
      let value = '; ' + document.cookie;
      let parts = value.split('; ' + name + '=');
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    // Calculate and display missing players and force start cost
    window.addEventListener('DOMContentLoaded', function() {
      const playersRequired = {{ match.playersRequired }};
      const currentPlayers = {{ match.currentPlayers }};
      const maxPlayers = {{ match.matchType.maxPlayers }};
      const entryFee = {{ match.matchType.entryFee|floatformat:0 }};
      const missing = playersRequired - currentPlayers;
      const emptySlots = maxPlayers - currentPlayers;
      
      // Update waiting message for minimum players
      const missingElem = document.getElementById('missingPlayers');
      if (missingElem) {
        missingElem.textContent = missing;
      }
      const pluralElem = document.getElementById('playerPlural');
      if (pluralElem) {
        pluralElem.textContent = missing > 1 ? 's' : '';
      }

      // Update force start cost display
      const emptySlotsElem = document.getElementById('emptySlots');
      if (emptySlotsElem) {
        emptySlotsElem.textContent = emptySlots;
      }
      const forceCostElem = document.getElementById('forceCost');
      if (forceCostElem) {
        const totalCost = emptySlots * entryFee;
        forceCostElem.textContent = totalCost;
      }

      // FIXED: Check if minimum players met and handle countdown
      {% if match.status == 'WAITING' and match.currentPlayers >= match.playersRequired %}
        const isReady = localStorage.getItem(READY_KEY);
        const countdownStart = localStorage.getItem(COUNTDOWN_KEY);
        
        if (!isReady || !countdownStart) {
          // First time reaching minimum players - start fresh countdown
          localStorage.setItem(READY_KEY, 'true');
          localStorage.setItem(COUNTDOWN_KEY, Date.now().toString());
          startCountdown();
        } else {
          // Already counting down - calculate remaining time
          const elapsed = Math.floor((Date.now() - parseInt(countdownStart)) / 1000);
          timeLeft = Math.max(0, 30 - elapsed);
          
          if (timeLeft > 0) {
            startCountdown();
          } else {
            // Time's up! Trigger auto-start
            triggerAutoStart();
          }
        }
      {% else %}
        // Clear countdown state if not ready
        localStorage.removeItem(READY_KEY);
        localStorage.removeItem(COUNTDOWN_KEY);
      {% endif %}

      // Start auto-refresh only if in WAITING or STARTING status
      {% if match.status == 'WAITING' or match.status == 'STARTING' %}
      autoRefreshInterval = setInterval(() => {
        location.reload();
      }, 3000);
      {% endif %}
    });

    function startCountdown() {
      const timerDisplay = document.getElementById('timerDisplay');
      const timerSeconds = document.getElementById('timerSeconds');
      
      // Update display immediately
      if (timerDisplay) {
        timerDisplay.textContent = timeLeft;
      }
      if (timerSeconds) {
        timerSeconds.textContent = timeLeft;
      }
      
      countdownInterval = setInterval(() => {
        timeLeft--;
        
        if (timerDisplay) {
          timerDisplay.textContent = timeLeft;
        }
        if (timerSeconds) {
          timerSeconds.textContent = timeLeft;
        }
        
        if (timeLeft <= 0) {
          clearInterval(countdownInterval);
          // Clear countdown state
          localStorage.removeItem(READY_KEY);
          localStorage.removeItem(COUNTDOWN_KEY);
          // Trigger auto-start
          triggerAutoStart();
        }
      }, 1000);
    }

    async function triggerAutoStart() {
      try {
        const response = await fetch('/matches/check-auto-start/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ matchId: {{ match.id }} })
        });

        const data = await response.json();

        if (data.success && data.started) {
          // Clear countdown state
          localStorage.removeItem(READY_KEY);
          localStorage.removeItem(COUNTDOWN_KEY);
          // Reload to see STARTING status
          location.reload();
        }
      } catch (error) {
        console.error('Auto-start error:', error);
        // Reload anyway to sync state
        location.reload();
      }
    }

    async function forceStartMatch() {
      const emptySlots = {{ match.matchType.maxPlayers }} - {{ match.currentPlayers }};
      const totalCost = emptySlots * {{ match.matchType.entryFee|floatformat:0 }};
      
      if (!confirm(`Pay ${totalCost} coins to fill ${emptySlots} empty slots and start now?`)) {
        return;
      }

      // Cancel auto-refresh and countdown
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
      if (countdownInterval) {
        clearInterval(countdownInterval);
      }

      // Clear countdown state
      localStorage.removeItem(READY_KEY);
      localStorage.removeItem(COUNTDOWN_KEY);

      try {
        const response = await fetch('/matches/force-start/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ matchId: {{ match.id }} })
        });

        const data = await response.json();

        if (data.success) {
          // Reload to see STARTING status
          location.reload();
        } else {
          alert('Error: ' + data.error);
          // Restart auto-refresh on error
          autoRefreshInterval = setInterval(() => {
            location.reload();
          }, 3000);
        }
      } catch (error) {
        alert('Error: ' + error.message);
        // Restart auto-refresh on error
        autoRefreshInterval = setInterval(() => {
          location.reload();
        }, 3000);
      }
    }

    async function leaveLobby() {
      if (!confirm('Leave lobby and get refunded?')) return;

      // Cancel auto-refresh and countdown before leaving
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
      if (countdownInterval) {
        clearInterval(countdownInterval);
      }

      // Clear countdown state
      localStorage.removeItem(READY_KEY);
      localStorage.removeItem(COUNTDOWN_KEY);

      try {
        const response = await fetch('/matches/leave-lobby/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ matchId: {{ match.id }} })
        });

        const data = await response.json();

        if (data.success) {
          const redirectUrl = '{% if privateCode %}/matches/private/{% else %}/matches/multiplayer/{% endif %}';
          window.location.href = redirectUrl;
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Clean up intervals when page is unloaded
    window.addEventListener('beforeunload', function() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
      if (countdownInterval) {
        clearInterval(countdownInterval);
      }
    });
  </script>
</body>
</html>