<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
  <title>Shop - Dash Arena</title>

  <script src="https://js.stripe.com/v3/"></script>

  <style>
    *{box-sizing:border-box;}
    body{font-family:system-ui,sans-serif;margin:0;background:#0d0f1a;color:#e6e6e6;}
    header{background:#121428;border-bottom:1px solid #23264a;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;}
    .brand{font-weight:700;font-size:20px;}
    .user{display:flex;align-items:center;gap:16px;}
    .coins{background:#2a2f6b;padding:8px 16px;border-radius:20px;font-weight:600;}
    .btn{background:#2a2f6b;color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:14px;text-decoration:none;}
    .btn:hover{background:#3940a3;}

    .container{max-width:1200px;margin:24px auto;padding:0 20px;}
    .section{background:#121428;border:1px solid #23264a;border-radius:12px;padding:24px;margin-bottom:24px;}
    h2{margin:0 0 16px;font-size:22px;}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px;}
    .card{background:#1a1d35;border:1px solid #2a2f6b;border-radius:10px;padding:20px;text-align:center;}
    .card:hover{border-color:#3940a3;}
    .card-title{font-weight:600;font-size:18px;margin-bottom:8px;}
    .card-desc{font-size:13px;color:#9ca3af;margin-bottom:16px;}
    .price{font-size:24px;font-weight:700;color:#5b7bff;margin-bottom:16px;}

    .purchase-btn{width:100%;background:#2a2f6b;color:#fff;border:none;padding:10px;border-radius:8px;font-weight:600;cursor:pointer;}
    .purchase-btn:hover{background:#3940a3;}

    #paymentModal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.8);
      z-index:1000;
      align-items:center;
      justify-content:center;
    }
    #paymentModal.active{display:flex;}

    .modal-content{
      background:#121428;
      border:2px solid #2a2f6b;
      border-radius:12px;
      padding:32px;
      max-width:500px;
      width:90%;
    }

    #card-element{
      background:#1a1d35;
      padding:12px;
      border-radius:8px;
      border:1px solid #2a2f6b;
      margin:16px 0;
    }

    #card-errors{color:#ef4444;font-size:14px;}
    .modal-actions{display:flex;gap:12px;margin-top:24px;}
    .modal-actions button{flex:1;}
  </style>
</head>

<body>

<header>
  <div class="brand">Dash Arena - Shop</div>
  <div class="user">
    <span class="coins">ðŸ’° {{ profile.coins|floatformat:0 }}</span>
    <span>{{ user.username }}</span>
    <a href="/" class="btn">Dashboard</a>
  </div>
</header>

<div class="container">
  <div class="section">
    <h2>ðŸ’Ž Coin Packages</h2>
    <div class="grid">
      {% for pkg in packages %}
      <div class="card">
        <div class="card-title">{{ pkg.name }}</div>
        <div class="card-desc">{{ pkg.coins }} coins</div>
        <div class="price">${{ pkg.price }}</div>
        <button class="purchase-btn"
          onclick="buyPackage({{ pkg.id }}, '{{ pkg.name }}', {{ pkg.price }})">
          Purchase
        </button>
      </div>
      {% empty %}
      <p style="color:#9ca3af;">No packages available.</p>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Payment Modal -->
<div id="paymentModal">
  <div class="modal-content">
    <h3 style="color:#5b7bff;">Complete Payment</h3>
    <div id="testModeNotice" style="background:#065f46;border:1px solid #10b981;color:#86efac;padding:12px;border-radius:6px;margin-bottom:12px;display:none;">
      <strong>ðŸ§ª Test Mode:</strong> Use test card 4242 4242 4242 4242 (any future date, any CVC)
    </div>

    <p>Package: <strong id="packageName"></strong></p>
    <p>Amount: <strong id="packagePrice"></strong></p>

    <input type="text" id="postalCode" placeholder="Postal Code" 
      style="width:100%;padding:10px;margin:12px 0;border-radius:8px;border:1px solid #2a2f6b;background:#1a1d35;color:#e6e6e6;">
    
    <div id="card-element"></div>
    <div id="card-errors"></div>

    <div class="modal-actions">
      <button class="btn" style="background:#991b1b;" onclick="closePaymentModal()">Cancel</button>
      <button class="btn" id="submitPayment">Pay Now</button>
    </div>
  </div>
</div>

<script>
  const stripePublicKey = '{{ stripePublicKey }}';
  let stripe, cardElement, clientSecret, isTestMode = false;

  if (stripePublicKey && typeof Stripe !== 'undefined') {
    stripe = Stripe(stripePublicKey);
    const elements = stripe.elements();

    cardElement = elements.create('card', {
      hidePostalCode: true,
      style: {
        base: {
          color: '#e6e6e6',
          fontFamily: 'system-ui, sans-serif',
          fontSize: '16px',
          '::placeholder': { color: '#9ca3af' }
        },
        invalid: { color: '#ef4444' }
      }
    });

    cardElement.on('change', e => {
      document.getElementById('card-errors').textContent =
        e.error ? e.error.message : '';
    });
  }

  function getCookie(name) {
    return document.cookie
      .split('; ')
      .find(row => row.startsWith(name + '='))
      ?.split('=')[1];
  }

  async function buyPackage(packageId, name, price) {
    if (!stripe) {
      alert('Stripe is not configured.');
      return;
    }

    try {
      const res = await fetch('/shop/create-payment-intent/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ packageId })
      });

      const data = await res.json();
      if (!data.success) throw new Error(data.error);

      clientSecret = data.clientSecret;
      isTestMode = data.testMode;

      document.getElementById('packageName').textContent = name;
      document.getElementById('packagePrice').textContent = '$' + price.toFixed(2);
      
      // Show test mode notice if enabled
      const testNotice = document.getElementById('testModeNotice');
      if (isTestMode) {
        testNotice.style.display = 'block';
      } else {
        testNotice.style.display = 'none';
      }

      document.getElementById('paymentModal').classList.add('active');
      cardElement.mount('#card-element');

    } catch (err) {
      alert(err.message);
    }
  }

  function closePaymentModal() {
    document.getElementById('paymentModal').classList.remove('active');
    document.getElementById('card-errors').textContent = '';
  }

  document.getElementById('submitPayment').addEventListener('click', async () => {
    if (!clientSecret) return;

    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'Processing...';

    const postalCode = document.getElementById('postalCode').value;

    const { error, paymentIntent } =
      await stripe.confirmCardPayment(clientSecret, {
        payment_method: { 
          card: cardElement,
          billing_details: {
            address: { postal_code: postalCode }
          }
        }
      });

    if (error) {
      document.getElementById('card-errors').textContent = error.message;
      btn.disabled = false;
      btn.textContent = 'Pay Now';
      return;
    }

    if (paymentIntent.status === 'succeeded') {
      alert('Payment successful!');
      location.reload();
    }
  });
</script>

</body>
</html>